{% load static %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}
<p>
    Please enter the details of all partners involved in the {{ activity }}. Include the applicant.<br>
    <strong>If a partner changes: please remove the partner and add a new one instead of editing the partner.</strong>
</p>

{{ proposal_partners_form.management_form }}

{% if proposal_partners_form.non_form_errors %}
    {{ proposal_partners_form|as_crispy_errors }}
{% endif %}

<table id="proposal_partners_form_table" class="table table-striped table-sm">
    <tbody>
    {% for proposal_partner_form in proposal_partners_form %}
        <tr>
            <td>
                {% crispy proposal_partner_form %}
            </td>
        </tr>

    {% endfor %}
    </tbody>
</table>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
    var jQueryForFormset = $.noConflict();
    {#jquery.formset doesn't work with jQuery 3 that we are using in the application#}
    {#Here we load the older one, we use for the formset but we let the $ be the newer version#}
</script>

{% include 'common/_orcid_javascript-form.tmpl' %}

<script src="{% static 'external/formset/jquery.formset.js' %}"></script>
<script>
    function added_proposal_partner_index(index) {
        let orcid = index + "-person__physical_person__orcid";
        let first_name = index + "-person__physical_person__first_name";
        let surname = index + "-person__physical_person__surname";

        setup_orcid_lookup('{{ proposal_partners_form.prefix }}', orcid, first_name, surname);
    }

    function added_proposal_partner(partner_row) {
        let index = parseInt(partner_row[0].sectionRowIndex);
        added_proposal_partner_index(index);
    }

    function removed_proposal_partner() {
        alert('removed proposal partner');
    }

    added_proposal_partner_index(0);

    jQueryForFormset(function () {
        jQueryForFormset('#proposal_partners_form_table tbody tr').formset({
            prefix: '{{ proposal_partners_form.prefix }}',
            added: added_proposal_partner,
            removed: removed_proposal_partner
        })
    })
</script>
